# Geo System â€” Data Tree & Pipeline

This folder explains the **geo data system** your site uses: a clear tree of **sources â†’ converters â†’ validators â†’ outputs â†’ consumers** with Mermaid diagrams and machine-friendly steps your agent can follow.

> **Goal:** Keep **GeoJSON** as the single source of truth, convert to **`areas.clusters.json`** + **`areas.adj.json`** for the site/deployer, and enforce **guardrails** before build.

---

## ðŸ“Š Diagrams

### 1) Data Tree (Mermaid mindmap)
```mermaid
mindmap
  root((Geo System))
    Data Sources
      GeoJSON Enriched (preferred)
      GeoJSON Basic (fallback)
      Suburbs CSV (optional)
      Adjacency CSV (optional)
      Region Map JSON (optional)
    Build Scripts
      csv-to-geojson.mjs
      geojson-to-clusters.mjs
      adjacency-from-csv.mjs
      validate-suburbs.mjs
      validate-adj.mjs
      prebuild-geo.sh
    Outputs
      areas.clusters.json
      areas.adj.json
    Consumers
      getStaticPaths (areas/[lga]/[suburb])
      (optional) service Ã— suburb pages
    Guardrails
      Biome + Prettier(.astro)
      Playwright + Axe (@a11y)
      PSI Budgets (perf:psi)
    CI Flow
      geo:prebuild --> astro build --> tests + perf:psi --> dist/
```

> The same diagram is saved as `geo-system-mindmap.mmd`.

### 2) End-to-End Pipeline (Mermaid flowchart)
```mermaid
flowchart TB
  subgraph Sources
    CSV[Suburbs CSV](optional)
    GJ[GeoJSON enriched](preferred)
    GJb[GeoJSON basic](fallback)
    ADJCSV[Adjacency CSV](optional)
    REGMAP[region-map.json](optional)
  end

  subgraph Converters
    C1[csv-to-geojson.mjs]
    C2[geojson-to-clusters.mjs]
    C3[adjacency-from-csv.mjs --symmetric]
  end

  subgraph Validators
    V1[validate-suburbs.mjs]
    V2[validate-adj.mjs]
  end

  subgraph Build
    P1[geo:prebuild]
    B1[astro build (SSG)]
  end

  subgraph Outputs
    O1[areas.clusters.json]
    O2[areas.adj.json]
    D[(dist/)]
  end

  CSV --> C1 --> GJ
  GJ --> C2 --> O1
  GJb --> C2
  REGMAP --> C2
  ADJCSV --> C3 --> O2
  O1 --> V1 --> P1
  O2 --> V2 --> P1
  P1 --> B1 --> D
  B1 --> PAGES[/areas/[lga]/[suburb]/]
  B1 -. optional .-> PAGES2[/services/[service]/[suburb]/]
```
> The same diagram is saved as `geo-system-flowchart.mmd`.

---

## ðŸ“¦ File Inventory (expected)

```
src/
  data/
    suburbs_enriched.geojson     # preferred input (single source of truth)
    suburbs.geojson              # fallback input
    areas.clusters.json          # generated by geojson-to-clusters.mjs
    areas.adj.json               # generated by adjacency-from-csv.mjs (or curated)
    adjacency.csv                # optional edge list (source,target) for adjacency
    region-map.json              # optional LGAâ†’region mapping used by converter
scripts/
  data/
    csv-to-geojson.mjs           # CSV â†’ GeoJSON
    geojson-to-clusters.mjs      # GeoJSON â†’ clusters.json
    adjacency-from-csv.mjs       # CSV edges â†’ adj.json, symmetric, deduped
    validate-suburbs.mjs         # validates FeatureCollection + fields
    validate-adj.mjs             # validates nodes, symmetry, loops
  perf/
    psi.mjs                      # PSI budgets script
  geo/
    prebuild-geo.sh              # runs converters + validators (hard fail on error)
```

---

## ðŸ§  Agent Playbook (machine-friendly)

**Preconditions**
- Node â‰¥ 20.3
- `ripgrep` available (check with `npm run health`)
- Datasets placed in `src/data/`

**Tasks**
1. **Convert sources**
   - If `src/data/suburbs_enriched.csv` exists, run: `npm run data:csv2geo`
   - Always run: `npm run geo:from:geojson`

2. **Build adjacency**
   - If `src/data/adjacency.csv` exists, run:
     `npm run geo:adj:from:csv`

3. **Validate datasets (hard fail)**
   - `npm run geo:validate`

4. **Build site**
   - `npm run build`  (ensure `build` chains `geo:prebuild` or call it first)

5. **Budgets & tests**
   - `npm run perf:psi`
   - `npm run test:e2e` (includes @a11y suite if tagged)

**Success criteria**
- `areas.clusters.json` and `areas.adj.json` exist and pass validators.
- `astro build` completes with no route or data errors.
- PSI budgets all pass (perf score, LCP, CLS, INP, TBT).
- E2E + a11y pass.

---

## ðŸ§­ Mapping rules (converter)

- **Name**: `name_official | suburb_name | name | suburb`
- **LGA Name**: `lga_name | lga | LGA | council`
- **Slugs**: use properties if present (`suburb_slug`, `lga_slug`), else derive via slugify.
- **Coordinates**: prefer `centroid_lat/centroid_lon`, else geometry `Point`.
- **Region**: `properties.region` or `src/data/region-map.json`, default `"brisbane"` (customize).

---

## ðŸ§ª Validation rules

- **Suburbs**: GeoJSON `FeatureCollection`, every feature must have a **name** and **LGA**.
- **Adjacency**: every node/edge id must exist in clusters, **no self loops**, **symmetric** graph.

---

## ðŸ†˜ Troubleshooting

- **No pages generated**: `getStaticPaths` sees 0 rows â†’ check `suburbs_enriched.geojson` and run `geo:from:geojson`.
- **Unknown ids in adjacency**: regenerate clusters first; ensure CSV uses slugs or names that map to existing clusters.
- **PSI fails intermittently**: add `PSI_API_KEY` to `.env` and retry, or relax budgets slightly for preview builds.

---

## ðŸ”— See also

- `docs/geo-system-mindmap.mmd`
- `docs/geo-system-flowchart.mmd`
