---
import logoImg from '~/assets/images/logo.svg';
import services from '~/data/services.json';
import coverage from '~/data/serviceCoverage.json';
import suburbs from '~/data/suburbs.json';
import topics from '~/data/topics.json';
import slugify from '~/utils/slugify.js';
import { rel, toCanonicalCluster } from '~/lib/paths';
import { trimSlashes } from '~/lib/str';

// Use centralized canonical cluster mapping from paths.ts

// Absolute URL builders
const servicePath        = (s)               => rel.service(s);
const suburbServicePath  = (service, suburb) => rel.suburbService(service, suburb);
const blogClusterPath    = (cluster)         => rel.blogCluster(toCanonicalCluster(cluster));
const blogCategoryPath   = (cluster, cat)    => rel.blogCategory(toCanonicalCluster(cluster), cat);

const legal = {
  privacy: rel.privacy(),
  terms:   rel.terms(),
  gallery: rel.gallery(),
  quote:   rel.quote(),
  sitemap: '/sitemap.xml',
};

// Page context → show Popular Areas only on service pages
const urlPath = (Astro.url.pathname || '/').replace(/\/+$/, '/') || '/';
const SERVICE_PAGE =
  /^\/services\/([^/]+)\/([^/]+)\/$/i.test(urlPath) ||
  /^\/services\/([^/]+)\/$/i.test(urlPath);

const currentService = (() => {
  const m = urlPath.match(/^\/services\/([^/]+)\//i);
  return m ? m[1] : null;
})();

// Services list (stable order from data)
const serviceLinks = (services || []).map((s) => ({
  name: s.name || s.title || s.slug,
  href: servicePath(s.slug || slugify(s.name)),
}));

// Popular Areas (deterministic top 3 for current service)
const SUBURB_SET = new Set((suburbs || []).map((s) => s.slug || slugify(s.name)));
const popularAreaLinks = (() => {
  if (!SERVICE_PAGE || !currentService) return [];
  const raw = coverage?.[currentService];
  const list = Array.isArray(raw)
    ? raw
    : ((raw?.popular || raw?.top || []));
  const cleaned = list.map(slugify).filter((slug) => SUBURB_SET.has(slug));
  const uniq = [...new Set(cleaned)].slice(0, 3);
  return uniq.map((slug) => ({
    name: (suburbs.find((s) => (s.slug || slugify(s.name)) === slug)?.name) || slug.replace(/-/g, ' '),
    href: suburbServicePath(currentService, slug),
  }));
})();

// Blog column (curated slugs → canonical, normalized URLs)
// Fallback to a safe default set if topics.footer.curated is missing
const defaultCurated = [
  'ipswich/bond-cleaning-checklist',
  'ipswich/what-agents-want',
  'ipswich/eco-bond-cleaning',
  'ipswich/client-stories',
];
const curatedBlogSlugs = (topics?.footer?.curated && Array.isArray(topics.footer.curated) ? topics.footer.curated : defaultCurated).map(String);

const blogLinks = curatedBlogSlugs.map((sl) => {
  const clean = trimSlashes(sl);
  const parts = clean.split('/');
  const [clusterRaw, a, b] = parts;
  const cluster = toCanonicalCluster(clusterRaw || '');

  let href = rel.blogRoot();
  let name = clean;

  if (a === 'category' && b) {
    href = blogCategoryPath(cluster, b);
    name = `Blog – ${b.charAt(0).toUpperCase()}${b.slice(1)}`;
  } else if (a) {
    href = rel.blogPost(cluster, a);
    name = a.replace(/-/g, ' ').replace(/\b\w/g, (m) => m.toUpperCase());
  } else {
    href = blogClusterPath(cluster);
    name = `Blog – ${cluster.charAt(0).toUpperCase()}${cluster.slice(1)}`;
  }
  return { name, href };
});

// NAP / contact card
const biz = {
  name: 'One N Done',
  tagline: 'Bond Cleaning Experts',
  suburb: 'Redbank Plains',
  region: 'QLD',
  postcode: '4301',
  phone: '+61405779420',
  email: 'info@onendonebondclean.com.au',
  social: {
    facebook: 'https://www.facebook.com/onendonebondclean',
    instagram: 'https://www.instagram.com/onendonebondclean',
  },
};
---

<footer class="bg-slate-950 text-slate-100" role="contentinfo">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 grid gap-10 md:grid-cols-12">
    <!-- Services -->
    <nav class="md:col-span-3" aria-labelledby="footer-services">
      <h2 id="footer-services" class="text-sm font-semibold uppercase tracking-wide text-slate-400">Services</h2>
      <ul class="mt-4 space-y-3">
        {serviceLinks.map((l) => (
          <li><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={l.href}>{l.name}</a></li>
        ))}
      </ul>
    </nav>

    <!-- Popular Areas (only on service pages) -->
    {popularAreaLinks.length > 0 && (
      <nav class="md:col-span-3" aria-labelledby="footer-areas">
        <h2 id="footer-areas" class="text-sm font-semibold uppercase tracking-wide text-slate-400">Popular Areas</h2>
        <ul class="mt-4 space-y-3">
          {popularAreaLinks.map((l) => (
            <li><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={l.href}>{l.name}</a></li>
          ))}
        </ul>
      </nav>
    )}

    <!-- From the Blog -->
    <nav class="md:col-span-3" aria-labelledby="footer-blog">
      <h2 id="footer-blog" class="text-sm font-semibold uppercase tracking-wide text-slate-400">From the Blog</h2>
      <ul class="mt-4 space-y-3">
        {blogLinks.map((l) => (
          <li><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={l.href}>{l.name}</a></li>
        ))}
      </ul>
    </nav>

    <!-- Contact card -->
    <section class="md:col-span-3">
      <div class="rounded-2xl bg-slate-900/70 p-5 ring-1 ring-white/10">
        <div class="flex items-center gap-3">
          <img src={logoImg.src} alt="" width="40" height="40" loading="lazy" decoding="async" />
          <div>
            <p class="font-semibold">{biz.name}</p>
            <p class="text-sm text-slate-400">{biz.tagline}</p>
          </div>
        </div>
        <address class="not-italic mt-4 space-y-1 text-sm text-slate-300">
          <div>{biz.suburb}, {biz.region}, {biz.postcode}</div>
          <div><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={`tel:${biz.phone}`}>{biz.phone}</a></div>
          <div><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={`mailto:${biz.email}`}>{biz.email}</a></div>
        </address>
        <div class="mt-3 flex gap-3">
          <a class="inline-flex h-11 w-11 items-center justify-center rounded-full bg-slate-800 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500"
             href={biz.social.facebook} rel="noopener noreferrer" target="_blank" aria-label="Facebook">f</a>
          <a class="inline-flex h-11 w-11 items-center justify-center rounded-full bg-slate-800 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500"
             href={biz.social.instagram} rel="noopener noreferrer" target="_blank" aria-label="Instagram">◎</a>
        </div>
      </div>
    </section>
  </div>

  <!-- legal row -->
  <div class="border-t border-white/10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col md:flex-row items-center gap-4 md:gap-8 justify-between">
      <p class="text-xs text-slate-400">© {new Date().getFullYear()} One N Done Bond Clean. All rights reserved.</p>
      <nav aria-label="Footer utility">
        <ul class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm">
          <li><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={legal.privacy}>Privacy Policy</a></li>
          <li><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={legal.terms}>Terms of Service</a></li>
          <li><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={legal.gallery}>Gallery</a></li>
          <li><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={legal.quote}>Get a Quote</a></li>
          <li><a class="inline-flex items-center min-h-11 hover:underline focus:outline-none focus:underline" href={legal.sitemap}>Sitemap</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Back to top (no-JS fallback + JS enhancement) -->
  <a href="#top" class="sr-only">Back to top</a>
  <button id="toTop" class="fixed bottom-5 right-5 hidden rounded-full bg-sky-600 text-white p-3 shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500" aria-label="Back to top">
    ↑
  </button>
  <script>
    const btn = document.getElementById('toTop');
    const show = () => { if (window.scrollY > 600) btn?.classList.remove('hidden'); else btn?.classList.add('hidden'); };
    show(); window.addEventListener('scroll', () => { window.requestAnimationFrame(show); }, { passive: true });
    btn?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
  </script>
</footer>
