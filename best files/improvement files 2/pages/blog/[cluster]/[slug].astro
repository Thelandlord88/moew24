---
import Layout from '~/layouts/MainLayout.astro';
import EcoLayout from '~/layouts/EcoLayout.astro';
import RelatedLinks from '~/components/RelatedLinks.astro';
import EcoSection from '~/components/EcoSection.astro';
import ThemedFaqSection from '~/components/ThemedFaqSection.astro';
// Legacy dynamic CrossServiceLinks removed; use static ServiceNav via crossService map
import ServiceNav from '~/components/ServiceNav.astro';
import { getCrossServiceLinks } from '~/lib/crossService';
import { toServiceCards } from '~/lib/links';
import areas from '~/content/areas.clusters.json';
import slugify from '~/utils/slugify.js';
import { chooseSuburbForPost } from '~/utils/chooseSuburbForPost';
import { buildGraph } from '~/utils/schemaGraph.js';
import topics from '~/data/topics.json';
import { resolveClusterSlug } from '~/utils/geoHandler';
import blogReviews from '~/data/blog-reviews.json';
import { CANONICAL_CLUSTERS } from '~/lib/clusters';
import { paths, rel } from '~/lib/paths';
import { absoluteUrl } from '~/lib/url';

// Type definitions for eco section registry
type SectionRenderer = (section: any) => any;
type SectionRegistry = Record<string, SectionRenderer>;

// 1. Required for static builds: generate all valid routes
export async function getStaticPaths() {
  const paths = [];
  for (const cluster of CANONICAL_CLUSTERS) {
    for (const topic of topics) paths.push({ params: { cluster, slug: topic.slug } });
  }
  return paths;
}

const { cluster, slug } = Astro.params;
const canonicalCluster = resolveClusterSlug(cluster);
if (canonicalCluster && canonicalCluster !== cluster) {
  return Astro.redirect(rel.blogPost(canonicalCluster, slug), 301);
}
const topic   = topics.find(t => t.slug === slug);
const clusterSlug = canonicalCluster || cluster;
// Pick an appropriate suburb for cross-service linking using chooser utility
let representativeSuburb = clusterSlug;
try {
  const fm = (topic as any) || {};
  const chosen = await chooseSuburbForPost({ suburbSlug: fm?.suburbSlug, suburbs: fm?.suburbs }, clusterSlug, slug);
  if (chosen) representativeSuburb = chosen;
  else {
    const clusterCfg = Array.isArray((areas as any)?.clusters) ? (areas as any).clusters.find((cc:any) => cc.slug === clusterSlug) : null;
    const first = clusterCfg?.suburbs?.[0];
    if (first) representativeSuburb = slugify(first);
  }
} catch {}
const clusterName = clusterSlug;
// removed unused suburbs variable (lint cleanup)
const local   = blogReviews;

// Canonical URL for JSON-LD Article
const pageUrl  = paths.blogPost(clusterSlug, slug);

// Checklist & theme detection
const isChecklist = slug === 'bond-cleaning-checklist';
const theme = (topic as any)?.theme || null;
const isEcoFriendly = theme === 'eco-minimal';
const headTitle = isChecklist
  ? `Bond Cleaning Checklist (${clusterName}) – Real‑Estate Approved Guide`
  : isEcoFriendly
  ? `Eco-Friendly Bond Cleaning ${clusterName} – Natural & Sustainable`
  : (topic?.title || 'Blog');
const headDescription = isChecklist
  ? 'Use this real‑estate‑approved bond cleaning checklist for Ipswich rentals. Clear steps by room, timing, and inspection tips—plus a 100% bond‑back service option.'
  : isEcoFriendly
  ? 'Discover how to get your bond back using eco-friendly, natural cleaning methods. Safe for your family and the environment, effective for property managers.'
  : (topic?.description || '');

// H1 string (avoid duplicating cluster if already present in title)
const clusterInTitle = topic?.title?.toLowerCase().includes((clusterName||'').toLowerCase());
const ecoAltTitle = (topic as any)?.hero?.altTitle;
const h1Text = isChecklist
  ? `Bond Cleaning Checklist – ${clusterName} (Real‑Estate Approved)`
  : isEcoFriendly && ecoAltTitle
  ? `${ecoAltTitle} in ${clusterName}`
  : isEcoFriendly
  ? `Natural Bond Cleaning in ${clusterName}`
  : (clusterInTitle ? topic?.title : `${topic?.title} – ${clusterName}`);

// Invalid JSON-LD block removed to fix build error
// This blog page is not in use
const article = topic ? {
  slug: topic.slug,
  title: topic.title,
  description: topic.description,
  date: topic.date || undefined,
  image: topic.featuredImage || undefined
} : undefined;
const area = { slug: clusterSlug, name: clusterName };
const breadcrumb = {
  itemListElement: [
  { '@type': 'ListItem', position: 1, name: 'Blog', item: paths.blogRoot() },
  { '@type': 'ListItem', position: 2, name: clusterName, item: paths.blogCluster(clusterSlug) },
    { '@type': 'ListItem', position: 3, name: topic?.title || '' }
  ]
};
const page = { breadcrumb };
const graph = buildGraph({ path: Astro.url?.pathname ?? '/', page, area, article });

// (Note) Removed previously unused `LayoutComponent` helper to reduce noise.
---

{isEcoFriendly ? (
  <EcoLayout title={headTitle} description={headDescription} canonical={pageUrl}>
    <Fragment slot="head">
      <script type="application/ld+json" is:inline set:html={JSON.stringify(graph)} />
    </Fragment>

    {/* Eco-friendly hero section */}
  <section class="eco-hero">
      <div class="eco-content">
    <p class="eco-hero-subtitle">{(topic as any)?.hero?.kicker || 'sustainable cleaning'}</p>
        <h1>{h1Text}</h1>
        <p class="eco-hero-description">
          Gentle on the environment, tough on dirt. Discover natural cleaning methods that property managers trust and your family will love.
        </p>
      </div>
    </section>

    {(() => {
      const registry: SectionRegistry = {
        'eco-benefits': (s) => <EcoSection subtitle={s.subtitle} title={s.title} benefits={s.benefits} cta={s.cta} />,
        'eco-toolkit': (s) => <section class="eco-section"><div class="eco-content"><h2>{s.title}</h2>{Array.isArray(s.blocks) && s.blocks.map((b:any) => (<div class="eco-card"><h3>{b.title}</h3><p>{b.body}</p></div>))}</div></section>,
        'eco-service-cta': (s) => <section class="eco-cta"><h2>{s.title}</h2>{s.body && <p>{s.body}</p>}<div class="eco-cta-row">{s.primary && <a href={s.primary.href} class="eco-btn">{s.primary.text}</a>}{s.secondary && <a href={s.secondary.href} class="eco-btn eco-btn-secondary">{s.secondary.text}</a>}</div></section>,
        'faq': () => <ThemedFaqSection includeJsonLd items={(topic?.faq||[]).map((f:any)=>({q:f.question||f.q,a:f.answer||f.a}))} heading="Eco-friendly cleaning questions" id="eco-faq" theme={theme} />
      };
      return Array.isArray((topic as any)?.sections)
        ? (topic as any).sections.map((s:any) => (registry[s.type] ? registry[s.type](s) : null))
        : null;
    })()}

  </EcoLayout>
) : (
  <Layout title={headTitle} description={headDescription} canonical={pageUrl}>
    <Fragment slot="head">
      <script type="application/ld+json" is:inline set:html={JSON.stringify(graph)} />
    </Fragment>

  <article class="max-w-3xl mx-auto py-12 px-4">
    <nav aria-label="Breadcrumb" class="mb-3 text-sm text-slate-600">
      <ol class="flex items-center gap-1">
  <li><a href={rel.blogRoot()} class="hover:underline">Blog</a></li>
        <li aria-hidden="true">/</li>
  <li><a href={rel.blogCluster(clusterSlug)} class="hover:underline">{clusterName}</a></li>
        <li aria-hidden="true">/</li>
        <li aria-current="page" class="text-slate-800 font-medium">{topic?.title}</li>
      </ol>
    </nav>
    <h1 class="text-3xl md:text-4xl font-extrabold mb-3 text-slate-900">{h1Text}</h1>
    <p class="text-slate-700 mb-6">{isChecklist ? 'Moving out in Ipswich? This practical bond cleaning checklist shows exactly what to clean, room‑by‑room, so your place meets agent expectations. Use it yourself—or book our local team to handle it for you. Either way, you’ll know what’s required and in what order to do it. (P.S. We include real‑estate specifics and timing notes to reduce last‑minute stress.)' : topic?.description}</p>

    <!-- Cross service links (static, precomputed) -->
    {(() => {
  const { crossServices, localGuides } = getCrossServiceLinks({ suburbSlug: representativeSuburb, currentService: 'bond-cleaning' });
  const cards = toServiceCards(crossServices, { currentSuburb: representativeSuburb });
  const localGuidesHrefs = Array.isArray(localGuides) ? localGuides : (localGuides ? [localGuides] : []);
  return <div class="mb-10"><ServiceNav services={cards} suburbs={[]} currentSuburb={representativeSuburb} localGuidesHrefs={localGuidesHrefs} /></div>;
    })()}

    {isChecklist && (
      <section class="mb-8">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between bg-sky-50 border border-sky-200 rounded-xl p-4">
          <p class="text-slate-800 font-medium">Kicker: Step‑by‑step tasks to pass inspection on the first go.</p>
          <a href="/services/bond-cleaning/" class="inline-flex items-center gap-2 bg-sky-700 hover:bg-sky-800 text-white font-bold px-5 py-3 rounded-full shadow focus-visible:ring-4 focus-visible:ring-sky-500/40 transition">
            Get a Free Quote
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </a>
        </div>
        <ul class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm text-slate-700">
          <li class="flex items-center gap-2"><span class="text-emerald-600">✔</span> 100% Bond‑Back Service Available</li>
          <li class="flex items-center gap-2"><span class="text-emerald-600">✔</span> Police‑Checked & Fully Insured</li>
          <li class="flex items-center gap-2"><span class="text-emerald-600">✔</span> No Hidden Fees</li>
        </ul>
      </section>
    )}

    {isChecklist && (
      <section class="mb-8">
        <h2 class="text-xl font-bold mb-2">TL;DR</h2>
        <p class="text-slate-700">What’s in a bond cleaning checklist? A complete top‑to‑bottom clean that covers kitchen appliances (including oven), bathrooms, walls, windows, fans, skirtings, blinds, floors, and outdoor areas—finished with a final detail pass for marks, cobwebs, and fixtures.</p>
      </section>
    )}

    {isChecklist && (
      <section class="mb-10">
      <h2 class="text-2xl font-bold mb-3">The {clusterName} Bond Cleaning Checklist</h2>
        <div class="space-y-5 text-slate-800">
          <div>
            <h3 class="font-semibold">Kitchen</h3>
            <ul class="list-disc list-inside space-y-1">
              <li>Oven (racks, trays, door glass), stovetop, rangehood filters</li>
              <li>Benchtops, splashbacks, cupboards (inside/out), sink & tapware</li>
              <li>Dishwasher filter, microwave, fridge space, floors & skirtings</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold">Bathrooms & Laundry</h3>
            <ul class="list-disc list-inside space-y-1">
              <li>Showers (glass, tracks, tiles, grout), bath, vanity, mirrors</li>
              <li>Toilets (base, seat hinges), exhaust fans & vents</li>
              <li>Laundry tub & taps, lint areas, floors & skirtings</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold">Bedrooms & Living</h3>
            <ul class="list-disc list-inside space-y-1">
              <li>Walls (spot‑marks), doors & handles, power points & switches</li>
              <li>Windows (tracks/sills), blinds, wardrobe tracks & mirrors</li>
              <li>Fans, light fittings, air‑con filters, carpets/hard floors</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold">Outdoors</h3>
            <ul class="list-disc list-inside space-y-1">
              <li>Balcony/patio sweep & spiderwebs, garage sweep, bins cleaned</li>
              <li>Entryway, letterbox, external cobwebs</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold">Final pass</h3>
            <ul class="list-disc list-inside space-y-1">
              <li>Patch missed marks, polish fixtures, remove all rubbish</li>
            </ul>
          </div>
        </div>
      </section>
    )}

    {isChecklist && (
      <section class="mb-8">
        <h2 class="text-xl font-bold mb-2">How long does a bond clean take?</h2>
  <p class="text-slate-700">For a typical unit or small house in the {clusterName}, allow 3–6 hours, depending on size, condition, and add‑ons (e.g., oven, blinds, carpets). Larger homes and heavily lived‑in spaces take longer—book earlier near peak moving dates.</p>
      </section>
    )}

    {isChecklist && (
      <section class="mb-10">
        <h2 class="text-xl font-bold mb-2">What agents check (and how to pass)</h2>
        <p class="text-slate-700">Property managers focus on appliances (especially ovens), bathrooms/grout, glass & tracks, walls/marks, and floors/carpets. Work from ceilings down; finish with a daylight “detail walk” using blue‑tack/cloth for spots. If time’s tight, book our 100% bond‑back service.</p>
      </section>
    )}

    {isChecklist && (
      <section class="mb-8">
        <h2 class="text-xl font-bold mb-3">Why choose One N Done</h2>
        <ul class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-slate-800">
          <li class="flex items-center gap-2"><span class="text-emerald-600">✔</span> 100% Bond‑Back Service with re‑clean support</li>
          <li class="flex items-center gap-2"><span class="text-emerald-600">✔</span> Police‑Checked, Fully Insured cleaners</li>
          <li class="flex items-center gap-2"><span class="text-emerald-600">✔</span> No Hidden Fees, fixed quotes</li>
          <li class="flex items-center gap-2"><span class="text-emerald-600">✔</span> Local Ipswich specialists; easy mobile tap‑to‑call</li>
        </ul>
        <div class="mt-4">
          <a href="/services/bond-cleaning/" class="inline-flex items-center gap-2 bg-sky-700 hover:bg-sky-800 text-white font-bold px-5 py-3 rounded-full shadow focus-visible:ring-4 focus-visible:ring-sky-500/40 transition">Get a Free Quote</a>
        </div>
      </section>
    )}
    {topic?.author && (
      <p class="text-xs text-slate-500 mb-4">By {topic.author} &middot; Published {topic.date || new Date().toLocaleDateString()}</p>
    )}

    {(isChecklist || topic?.faq) && (
      <section class="mb-8">
        <h2 class="text-xl font-bold mb-2">FAQs</h2>
        {isChecklist ? (
          <Fragment>
            <details class="mb-2 border-b"><summary class="py-2 font-semibold cursor-pointer">What is bond cleaning?</summary><p class="pb-2">Bond cleaning (end‑of‑lease cleaning) is a full property clean that returns your rental to its original condition so you can recover your rental bond. It covers appliances, bathrooms, walls, windows/tracks, fans, blinds, floors, and outdoor areas, finished with a final detail check.</p></details>
            <details class="mb-2 border-b"><summary class="py-2 font-semibold cursor-pointer">Do I need professional bond cleaners to get my bond back?</summary><p class="pb-2">Not always—but professionals save time and meet agent standards in one visit, especially for ovens, bathrooms, windows, and grout. If you DIY, follow the full checklist; if time’s short, booking a 100% bond‑back service is the safer route.</p></details>
            <details class="mb-2 border-b"><summary class="py-2 font-semibold cursor-pointer">How long will my clean take?</summary><p class="pb-2">Most smaller Ipswich rentals take 3–6 hours; larger/older homes or heavy wear add time. Book early near end‑of‑month peaks.</p></details>
            <details class="mb-2 border-b"><summary class="py-2 font-semibold cursor-pointer">What if something’s missed?</summary><p class="pb-2">Ask for a re‑clean guarantee window. Our bond‑back service includes fast touch‑ups aligned to agent feedback so you pass inspection.</p></details>
          </Fragment>
        ) : (
          topic.faq.map(q => (
            <details class="mb-2 border-b">
              <summary class="py-2 font-semibold cursor-pointer">{q.q}</summary>
              <p class="pb-2">{q.a}</p>
            </details>
          ))
        )}
      </section>
    )}

  <h2 class="text-xl font-bold mb-2">Real Reviews ({clusterName})</h2>
    <ul>
      {local.filter(r => r.cluster === clusterName).length === 0 ? (
        <li>No local reviews yet—yours could be first!</li>
      ) : (
        local.filter(r => r.cluster === clusterName).map(r => (
          <li class="mb-3 border-b pb-2">
            <blockquote>“{r.text}”</blockquote>
            <footer class="text-xs text-slate-500">— {r.author}, {r.suburb} &middot; <span class="text-yellow-500">{'★'.repeat(r.rating)}</span></footer>
          </li>
        ))
      )}
    </ul>

  <div class="sticky bottom-0 bg-sky-800 text-white font-bold px-4 py-3 text-center rounded-t-xl">
      <a href="/quote" class="hover:underline">Get My Free Quote</a>
    </div>

    <section class="mt-12">
      <h2 class="text-lg font-bold mb-2">Related Topics</h2>
      <ul class="flex flex-wrap gap-3">
        {topics.filter(t => t.category === topic?.category && t.slug !== slug).slice(0, 5).map(t => (
          <li>
            <a href={rel.blogPost(clusterSlug, t.slug)} class="text-sky-600 hover:underline">
              {t.title}
            </a>
          </li>
        ))}
      </ul>
    </section>
  </article>
  {isChecklist && (
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        { "@type": "Question", "name": "What is bond cleaning?", "acceptedAnswer": { "@type": "Answer", "text": "Bond cleaning (end‑of‑lease cleaning) is a full property clean that returns your rental to its original condition so you can recover your rental bond. It covers appliances, bathrooms, walls, windows/tracks, fans, blinds, floors, and outdoor areas, finished with a final detail check." }},
        { "@type": "Question", "name": "Do I need professional bond cleaners to get my bond back?", "acceptedAnswer": { "@type": "Answer", "text": "Not always—but professionals save time and meet agent standards in one visit, especially for ovens, bathrooms, windows, and grout. If you DIY, follow the full checklist; if time’s short, booking a 100% bond‑back service is the safer route." }},
        { "@type": "Question", "name": "How long will my clean take?", "acceptedAnswer": { "@type": "Answer", "text": "Most smaller Ipswich rentals take 3–6 hours; larger/older homes or heavy wear add time. Book early near end‑of‑month peaks." }},
        { "@type": "Question", "name": "What if something’s missed?", "acceptedAnswer": { "@type": "Answer", "text": "Ask for a re‑clean guarantee window. Our bond‑back service includes fast touch‑ups aligned to agent feedback so you pass inspection." }}
      ]
    })} />
  )}
  {(!isChecklist && Array.isArray(topic?.faq)) && (() => {
    const cleaned = topic.faq.filter(q => q && typeof q.q === 'string' && typeof q.a === 'string' && q.q.trim() && q.a.trim());
    if (cleaned.length === 0) return null;
    return <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": cleaned.map((q) => ({
        "@type": "Question",
        "name": q.q.trim().endsWith('?') ? q.q.trim() : q.q.trim() + '?',
        "acceptedAnswer": { "@type": "Answer", "text": q.a }
      }))
    })} />;
  })()}
  <!-- Article JSON-LD (safe optional fields) -->
  {topic && (
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": topic.title,
      ...(topic.description ? { "description": topic.description } : {}),
      "mainEntityOfPage": pageUrl,
  "image": absoluteUrl('/og.jpg'),
      "author": topic.author ? { "@type": "Person", "name": topic.author } : { "@type": "Organization", "name": "One N Done Bond Clean" },
      ...(topic.date ? { "datePublished": topic.date } : {})
    })} />
  )}
  {/* BreadcrumbList JSON-LD */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {"@type": "ListItem", "position": 1, "name": "Blog", "item": paths.blogRoot()},
      {"@type": "ListItem", "position": 2, "name": clusterName, "item": paths.blogCluster(clusterSlug)},
      {"@type": "ListItem", "position": 3, "name": topic?.title || ''}
    ]
  })} />
  </Layout>
)}
