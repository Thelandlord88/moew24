---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import { allPosts, filterByTag, paginate } from "../../../../lib/blog";
import PostCard from "../../../../components/PostCard.astro";
import Pagination from "../../../../components/Pagination.astro";
import { TAG_INTROS } from "@/content/taxonomy";

export async function getStaticPaths() {
  const posts = await allPosts();
  const tags = new Set<string>();
  posts.forEach(p => p.data.tags.forEach(t => tags.add(t)));
  return [...tags].map((t) => ({ params: { tag: t } }));
}

const tag = Astro.params.tag!;
const posts = filterByTag(await allPosts(), tag);
const pager = paginate(posts, 1);
const base = `/blog/tag/${tag}/`;
const canonical = new URL(base, Astro.site).toString();
const tagIntro = TAG_INTROS[tag];
---

<BaseLayout title={`Tag: ${tag}`} description={`Articles tagged ${tag}`} canonical={canonical}>
  <h1 class="text-3xl font-bold mb-6">Tag: {tag}</h1>
  
  {tagIntro && (
    <p class="text-slate-600 mb-6">{tagIntro}</p>
  )}

  {pager.data.length === 0 ? (
    <p class="text-slate-600">No posts found.</p>
  ) : (
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {pager.data.map((post) => <PostCard post={post} />)}
    </div>
  )}

  <Pagination basePath={base} page={pager.page} lastPage={pager.lastPage} />
  <p class="mt-6 text-sm text-slate-500">RSS: <a class="underline" href={`${base}rss.xml`}>Tag feed</a></p>
</BaseLayout>
